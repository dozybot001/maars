# 执行图布局排序规则

本文档描述 `stage_layout` 中执行图（按 stage 分层的任务依赖图）的节点排序与垂直对齐规则。

---

## 一、基本定义

### 1.1 跨层连线

- **跨层连线**：连接非相邻层级的边（如 stage 1 → stage 3）
- **跨层任务**：该任务存在**跨层连出线**（有边连到下游非相邻层）
- **不算跨层**：若任务只有上游跨层连线到它（仅连入线），则**不**视为跨层任务

### 1.2 连接类型（仅考虑相邻层连线）

| 类型 | 含义 | 合并节点 |
|------|------|----------|
| 一对多 | 1 个上游 → 多个下游 | 合并节点算作「一」 |
| 一对一 | 1 个上游 → 1 个下游 | — |
| 多对一 | 多个上游 → 1 个下游 | 合并节点算作「一」 |

### 1.3 跨层数

- 某条边的跨层数 = `stage_dst - stage_src`（目标层 − 源层）
- 任务的**最大跨层数** = 该任务所有**连出线**中跨层数的最大值（仅连出线，不含连入线）

---

## 二、Layer 0（根层）排序

1. **非跨层任务**：按 一对多 > 一对一 > 多对一 排序
2. **跨层任务**：排在最后，按最大跨层数升序（跨层越多越靠后）
3. **同类型内部**：按 id 排序（如两个一对多任务按 id 排）

---

## 三、下游层排序与对齐

对每一层，从上游到下游递归处理。

### 3.1 第一步：摘出跨层任务

- 找出本层中**有跨层连出线**的任务
- 这些任务**放在本层最后**，**不参与**后续对齐计算
- 跨层任务之间按**最大跨层数升序**，同值按 id

### 3.2 第二步：非跨层任务排序与对齐

仅对**无跨层连出线**的任务进行排序和对齐：

| 连接类型 | 排序优先级 | 垂直对齐规则 |
|----------|------------|--------------|
| 一对多 | 1（最高） | 本层「多」的**中心**与上游「一」垂直对齐 |
| 一对一 | 2 | 本层节点与上游节点**垂直对齐** |
| 多对一 | 3 | 本层「一」与上游「多」的**中心**垂直对齐 |

同类型内部按 id 排序。

### 3.3 第三步：跨层任务放置

- 跨层任务紧接在非跨层任务之后
- 按顺序排列，不参与对齐

---

## 四、流程概览

```
每层处理：
  1. 摘出有跨层连出线的任务 → 放最后，按最大跨层数升序、id
  2. 非跨层任务：按 一对多 > 一对一 > 多对一 排序
  3. 非跨层任务：按对齐规则计算 x 坐标
  4. 跨层任务：在非跨层之后顺序排列
```

---

## 五、示例

- **一对多**：A → B、C、D，则 B、C、D 的中心与 A 垂直对齐
- **一对一**：A → B，则 B 与 A 垂直对齐
- **多对一**：A、B、C → D，则 D 与 A、B、C 的中心垂直对齐
- **跨层**：A 有边到 B（相邻）和 C（跨层），则 A 视为跨层任务，排在最后，不参与对齐

---

## 六、连线样式

- **相邻层连线**：上游下侧中点 → 下游顶部中心，实线
- **跨层连线**：上游下侧中点 → 下游顶部中心，虚线样式
